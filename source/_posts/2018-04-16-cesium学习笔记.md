---
title: cesium学习笔记
date: 2018-04-16 17:01:44
tags: cesium
---

### 2018.05.07

Globe 上的 ClippingPlane 定一个法向量就可以了，distance是相对与 ClippingPlaneCollection 的 ModelMatrix 的，它是以笛卡尔坐标系的中心建立了一个穿过整个坐标系的平面组，所以会在地球表面形成两个相对的切面。

如何计算一个离某个点距离为 radius 的圆的坐标：
```javascript
let n = 180, points = [];
let center = tileset.boundingSphere.center, radius = tileset.boundingSphere.radius;
let R = viewer.scene.globe.ellipsoid.maximumRadius; //地球半径
center = Cesium.Cartographic.fromCartesian(center); //转成经纬度坐标
//latB = latA-((radius * Math.sin(Math.PI * i / n)) * 180) / (Math.PI * ellipsoid.R)
//latB = LatA-(Y*180)/(Math.PI * e)
//loB = loA - ((rdius * Math.cost(Math.PI * i / n)) * 180) / (Math.PI * ellipsoid.R * Math.cos((LatA + LatB) / 2))
//loB = loA - (x*180)/(math.pi * r * cost((latA + latB) / 2))
for (let i = -n; i <= n; i++) {
let x = Math.cos(Math.PI * i / n) * radius;
let y = Math.sin(Math.PI * i / n) * radius;
//let LatB = center.latitude - (y * 180) / (Math.PI * R);
let LatB = center.latitude - (y / R);
//let LonB = center.longitude - (x * 180) / (Math.PI * R * Math.cos((center.latitude + LatB) / 2));
let LonB = center.longitude - (x / (R * Math.cos((center.latitude + LatB) / 2)));
let point = new Cesium.Cartographic(LonB, LatB);
point = viewer.scene.globe.ellipsoid.cartographicToCartesian(point);
points.push(point);
}
```
这个是不精确的版本，在小范围误差可接受，参考自[地理空间距离计算优化](https://tech.meituan.com/lucene-distance.html)

Polyline 这个 Geometry 不支持 heightReference，于是不会自动贴地。必须通过 Cesium.sampleTerrainMostDetailed 这个方法吧 positions 中的点进行高度调整，其中 pointsR 为高度为零的 Cartographic 对象。
```javascript
Cesium.when(Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, pointsR), (samples) => {
for (let sample of samples) sample.height += 10.0;
viewer.entities.add({
polyline: {
positions: Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(samples),
width: 5,
material: Cesium.Color.WHITE,
},
});
});
```

### 2018.05.03

不支持 KHR_materials_pbrSpecularGlossiness 

Entity 保存了 Graphic
Graphic 保存 Geometry 对象的描述属性，但没有定义怎么画出这个对象

Billboard:

Billboard

* @performance Reading a property, e.g., {@link Billboard#show}, is constant time.
* Assigning to a property is constant time but results in
* CPU to GPU traffic when {@link BillboardCollection#update} is called. The per-billboard traffic is
* the same regardless of how many properties were updated. If most billboards in a collection need to be
* updated, it may be more efficient to clear the collection with {@link BillboardCollection#removeAll}
* and add new billboards instead of modifying each one.
照这么说来，当 BillboardCollection.update 的时候才会处理成 GPU 的数据发送至 GPU

BillboradGraphics
BillboardGraphicsSpec

BillboardCollection
BillboardCollectionSpec

BillboardVisualizer
BillboardVisualizerSpec

BillboardCollectionFS.glsl
BillboardCollectionVS.glsl

createBillboardPointCallback 



Entity 不指定方向的情况下用 eastNorthUpToFixedFrame


### 2018.04.27

Cesium 画geometry的效率
Billboard 》polyline > box = plane 》 polygon(不带挤压高度) > polygon(带挤压高度) 

一万个 ellipse ellipsoid cylinder corrdior 会有内存不足的问题

画一个带指示线的标签

```javascript
var viewer = new Cesium.Viewer('cesiumContainer',
                               {timeline: false, animation: false});
var scene = viewer.scene;
var offsetX = 50, offsetY = -80;
var pos = Cesium.Cartesian3.fromDegrees(-75.1641667, 29.9522222);
var labels = scene.primitives.add(new Cesium.LabelCollection());
labels.add({
    position: pos,
    text: 'Another label',
    pixelOffset: new Cesium.Cartesian2(offsetX, offsetY)
});
var canvas = document.createElement('canvas');
canvas.width = Math.abs(offsetX);
canvas.height = Math.abs(offsetY);
var context2D = canvas.getContext('2d');
context2D.beginPath();
context2D.lineWidth = 3;
context2D.strokeStyle = '#ffffff';
context2D.moveTo((offsetX < 0) ? -offsetX : 0, (offsetY < 0) ? -offsetY : 0);
context2D.lineTo((offsetX < 0) ? 0 : offsetX, (offsetY < 0) ? 0 : offsetY);
context2D.stroke();
var billboards = scene.primitives.add(new Cesium.BillboardCollection());
var billboard = billboards.add({
    color : Cesium.Color.RED,
    image : canvas,
    pixelOffset: new Cesium.Cartesian2(offsetX * 0.5, offsetY * 0.5),
    position : pos
});

```
[https://stackoverflow.com/questions/32716118/cesium-js-how-draw-line-binding-a-label-to-a-position]( https://stackoverflow.com/questions/32716118/cesium-js-how-draw-line-binding-a-label-to-a-position)

### 2018.04.26

Primitive 对象有定点着色器与片元着色器的源代码入口

Viewer.scene.drillPick 返回的 pickedObjects 数组对象
pickedObject.id 为 entity
pickedObject.primitive 为相应的 primitive 对象


添加X,Y,Z三轴线

```javascript
var modelMatrix = Cesium.Transforms.headingPitchRollToFixedFrame(position, hprRollZero, Cesium.Ellipsoid.WGS84, converter);
    scene.primitives.add(new Cesium.DebugModelMatrixPrimitive({
        modelMatrix : modelMatrix,
        length : 300.0,
        width : 10.0
    }));
```
### 2018.04.24
Geometry画出来的图形是以地球坐标系来画的， Model是以模型自身的坐标系来画的，3DTileset是以地球坐标系来画的

3DTileset.debugWireframe可以显示骨架

### 2018.04.16

Cesium Pick有BUG，它是根据3DTiles的boundingSphere加上geometryError来确定模型占地面积，由maximumHeight的两倍来确定模型的高度。模型在这个范围内浮动，不会有明显的问题，超出这个范围就会有点选不中，显示异常的问题。

3DTileset的modelMatrix是整个set共用的，pickedFeature里的
